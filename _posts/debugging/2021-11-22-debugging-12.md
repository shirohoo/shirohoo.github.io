---
layout: post
category:
    - debugging
title: Nginx 80 to 443 redirect not working
description: >
    HTTP(=80) μ ‘μ† μ‹ HTTPS(=443)λ΅ ν¬νΈν¬μ›λ”©μ΄ λμ§€ μ•λ” λ¬Έμ 
image: /assets/img/debugging/debugging.jpg
accent_image:
    background: url('/assets/img/debugging/debugging.jpg') center/cover
related_posts:
    -
---

* toc
{:toc}
  
<br />

# π¨ λ¬Έμ 

---

μ‚¬μ΄λ“ ν”„λ΅μ νΈ μ„λ²„ κµ¬μ¶•μ¤‘ ν• μ‚½μ§μ΄λ‹¤

1. `Nginx`λ¥Ό λ¦¬λ²„μ¤ ν”„λ΅μ‹λ΅ λ„μ…
2. SSL λ°κΈ‰ λ° HTTPS κµ¬μ¶•
3. HTTPS 2.0 μ„¤μ •

μ™„λ£ ν›„ μ°λ¦¬ μ‚¬μ΄λ“ ν”„λ΅μ νΈ λ„λ©”μΈμ— μ ‘μ†ν•λ”λ°, `http://domain` μΌλ΅ μ ‘μ†ν•λ©΄ `https://domain` μΌλ΅ λ¦¬λ‹¤μ΄λ ‰νΈκ°€ λμ§€ μ•λ” λ¬Έμ κ°€ μμμ„ μ•μ•λ‹¤.

<br />

# π§ μ›μΈ

---

μ²μμ—” λ°”λ΅ `nginx.conf` λ¥Ό ν™•μΈν–μΌλ‚, μ—­μ‹ μ•„λ¬΄λ° μ΄μƒ μ—†μ΄ μ μ„¤μ •λΌμμ—λ‹¤.

<br />

```shell
 server {
        listen 80;
        listen 443 ssl http2;
        server_name example.com www.example.com;
        root         /var/www/html;

        gzip on;
        gzip_comp_level 6;
        gzip_min_length 500;
        gzip_buffers 16 8k;
        gzip_proxied any;

        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
        ssl_protocols TLSv1.2;
        ssl_ciphers HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers on;

        if ($scheme != "https") {
            return 301 https://$host$request_uri;
        }
```

<br />

λ¶„λ… μ•„λ¬΄λ° λ¬Έμ κ°€ μ—†λ”λ° λ‹Ήμ—°ν λμ•Ό ν•  κ²ƒμ΄ μ•λλ‹ μ• κΏμ€ `nginx.conf`λ§ κ³„μ† κ³ μ³λ΄¤λ‹¤. (μ΄λ¬λ©΄ μ•λλ”λ° π­)

ν•μ‹κ°„μ •λ„ μ΄μ§“κ±°λ¦¬λ¥Ό ν•λ‹¤κ°€ μ κΉ ν„νƒ€κ°€ μ™€μ„ λ©λ•λ¦¬λ”λ°, λ¬Έλ“ `λ°©ν™”λ²½μ΄ λ¬Έμ  κ°€?` λΌλ” μƒκ°μ΄ λ“¤μ–΄μ„ λ°©ν™”λ²½μ„ ν™•μΈν•΄λ³΄λ‹...

<br />

```shell
$ sudo iptables -t nat -L --line-numbers
Chain PREROUTING (policy ACCEPT)
num  target     prot opt source               destination
1    REDIRECT   tcp  --  anywhere             anywhere             tcp dpt:http redir ports 8080

Chain INPUT (policy ACCEPT)
num  target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
num  target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
num  target     prot opt source               destination
```

<br />

**λ¦¬λ…μ¤ λ°©ν™”λ²½μ—μ„ 80ν¬νΈ μ ‘μ†μ‹ 8080μΌλ΅ λ¦¬λ‹¤μ΄λ ‰νΈλκ² ν¬νΈν¬μ›λ”© μ„¤μ •μ΄ λΌμμ—λ‹¤.**

μ΄λ• λ¬Έλ“ μ²μ μ„λ²„ κµ¬μ¶•ν• λ• λ‚΄κ°€ μ„μ‹λ΅ μ΄κ±Έ μ„¤μ •ν•΄λ’€λκ² μ„¬κ΄‘μ²λΌ λ– μ¬λλ‹¤... π«π«π«

<br />

# π‚ ν•΄κ²°

---

![image](https://user-images.githubusercontent.com/71188307/142854123-f42735ee-f279-4bd2-9551-94c20a1f8eb5.png)

<br />

```shell
$ sudo iptables -t nat -D PREROUTING 1
```

<br />

... μκ΄΄κ°μ— ν—μ°μ λ€λ©° ν•΄λ‹Ή μµμ…μ„ μ κ±°ν•λ‹ μ ν•΄κ²°λμ—λ‹¤...

λ‚΄ ν•μ‹κ°„... π«

<br />
