---
layout: post
category:
  - spring
  - spring-data-jpa
title: JPA @OneToOne ìŠ¬ê¸°ë¡­ê²Œ ì‚¬ìš©í•˜ê¸°
description: |
  ì‚¬ìš©í•˜ê¸° ê¹Œë‹¤ë¡œìš´ @OneToOne ! ì–´ë–»ê²Œ ì‚¬ìš©í•´ì•¼ í• ê¹Œ?
image: /assets/img/spring/spring-data-jpa/hibernate.jpg
related_posts:
  - _posts/spring/spring-data-jpa/2021-05-31-one-to-one.md 
published: true
---

* toc 
{:toc}

<br />

# ğŸ’¥ @OneToOne ì´ìŠˆ

---

`JPA(Hibernate)`ë¥¼ ì‹¤ë¬´ì—ì„œ ì‚¬ìš©í•´ë³´ì‹  ë¶„ì´ë¼ë©´ ì•„ì‹œê² ì§€ë§Œ, `@OneToOne`ì€ ì§€ì—°ë¡œë”© ê´€ë ¨ ì´ìŠˆê°€ ì¡´ì¬í•œë‹¤.

ë”°ë¼ì„œ ì´ë¥¼ ì‚¬ìš©í•˜ë©´ `N+1` ë¬¸ì œê°€ ê³§ì˜ í„°ì ¸ë‚˜ì™€ ì‚¬ìš©í•˜ê¸°ê°€ ì—¬ê°„ ê¹Œë‹¤ë¡œìš´ê²Œ ì•„ë‹ˆë‹¤.

`@OneToOne`ìœ¼ë¡œ ì§€ì—°ë¡œë”©ì„ í•˜ê¸° ìœ„í•´ì„œëŠ” ì ˆëŒ€ì ìœ¼ë¡œ ì•„ë˜ì˜ ì¡°ê±´ì´ ì„±ë¦½í•´ì•¼ë§Œ í•œë‹¤

<br />

- `optional=false` ì˜µì…˜ì´ ìˆì–´ì•¼ í•œë‹¤ (=NOT NULL)

<br />

ì´ ì¡°ê±´ì´ ì„±ë¦½í•œë‹¤ë©´ ì•„ë˜ì˜ ê²½ìš°ì— ì§€ì—°ë¡œë”©ì´ ê°€ëŠ¥í•´ì§„ë‹¤

<br />

- @OneToOne ë‹¨ë°©í–¥
- @OneToOne ì–‘ë°©í–¥ì´ì§€ë§Œ ê´€ê³„ì˜ ì£¼ì¸ìª½ì—ì„œ ì¡°íšŒë¥¼ í•œ ê²½ìš°

<br />

ì¦‰, ì–´ë–»ê²Œ í•´ë„ ì–‘ë°©í–¥ ë§¤í•‘ ì‹œ ê´€ê³„ì˜ ì£¼ì¸ì´ ì•„ë‹Œê³³ì—ì„œ ì‘ì—…ì´ ë“¤ì–´ê°€ë©´ N+1 ë¬¸ì œê°€ í„°ì ¸ë‚˜ì˜¨ë‹¤.

ë˜í•œ ì¶”ê°€ë¡œ ê´€ê³„ì˜ ì£¼ì¸ì´ ì•„ë‹Œë…€ì„ì€ ê¸°ë³¸ì ìœ¼ë¡œ `ì½ê¸° ì „ìš©(Read Only)`ì´ê¸° ë•Œë¬¸ì—, `CUD(Create, Update, Delete)`ë„ ì œëŒ€ë¡œ ë˜ì§€ ì•ŠëŠ” ê²½ìš°ê°€ ìƒê¸¸ ìˆ˜ ìˆë‹¤.

<br />

<u>í™•ì¸í•´ë³´ì</u>

<br />

```java

@Table
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    private String title;

    @OneToOne(
        mappedBy = "member",
        fetch = FetchType.LAZY,
        cascade = CascadeType.ALL,
        optional = false
    )
    private Locker locker;

    public void setLocker(Locker locker) {
        if (locker == null) {
            if (this.locker != null) {
                this.locker.setMember(null);
            }
        }
        else {
            locker.setMember(this);
        }
        this.locker = locker;
    }

}

@Table
@Setter
@Entity
public class Locker {

    @Id
    @GeneratedValue
    private Long id;

    @OneToOne(fetch = FetchType.LAZY)
    private Member member;

}
```

<br />

ê´€ê³„ì˜ ì£¼ì¸ì€ `Locker`ì´ë‹¤.

`optional=false`ë¥¼ ëª…ì‹œí•´ì£¼ì–´ ë§¤í•‘ëœ ê°ì²´ê°€ `NULL`ì¼ ê²½ìš°ì˜ ìˆ˜ë¥¼ ë°°ì œí•´ì£¼ì—ˆë‹¤.

ì´ëŠ” `Hibernate`ê°€ `í”„ë¡ì‹œ`ë¥¼ ì±„ì›Œì£¼ì–´ì•¼ í• ì§€ `NULL`ì„ ë„£ì–´ì•¼ í• ì§€ ì•Œì§€ ëª»í•´ ì¿¼ë¦¬ë¥¼ ë•Œë ¤ë³´ëŠ”(Eager ë™ì‘ìœ¼ë¡œ ì¸í•œ N+1) ë¶ˆìƒì‚¬ê°€ ì¼ì–´ë‚˜ì§€ ì•Šì„ ìˆ˜ ìˆëŠ” ê¸°ë°˜ì„ ë§ˆë ¨í•´ì¤€ê²ƒì´ë‹¤.

<br />

> [ğŸ“œ OneToOneì— ëŒ€í•´ì„œ](./2021-05-31-one-to-one.md){:target="_blank"}

<br />

ì´ ìƒíƒœì—ì„œ ì•„ì£¼ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ì.

`Locker`ê°€ ê´€ê³„ì˜ ì£¼ì¸ì´ë¯€ë¡œ, `Locker`ë¥¼ ì¿¼ë¦¬í•˜ë©´ `N+1 ë¬¸ì œ`ê°€ ë°œìƒí•˜ì§€ ì•Šì•„ì•¼ í•œë‹¤.

ë”°ë¼ì„œ <u>select ì¿¼ë¦¬ëŠ” ë‹¨ í•œë²ˆë§Œ ë°œìƒí•´ì•¼ í•œë‹¤.</u>

<br />

```java

@DataJpaTest
@Rollback(false)
class MemberTest {

    @Autowired
    TestEntityManager em;

    @BeforeEach
    void setUp() {
        Locker locker = new Locker();
        Member member = new Member();
        member.setLocker(locker);
        em.persist(member);
        em.flush(); // insert ë‘ë²ˆ ë°œìƒ
        em.clear();
    }

    @Test
    void find() throws Exception {
        em.find(Locker.class, 1L); // select í•œë²ˆ ë°œìƒ
    }

}
```

<br />

```shell
Hibernate: 
    insert 
    into
        member
        (name, id) 
    values
        (?, ?)
Hibernate: 
    insert 
    into
        locker
        (member_id, thing, id) 
    values
        (?, ?, ?)
Hibernate: 
    select
        locker0_.id as id1_0_0_,
        locker0_.member_id as member_i3_0_0_,
        locker0_.thing as thing2_0_0_ 
    from
        locker locker0_ 
    where
        locker0_.id=?
```

<br />

`Member`ì™€ `Locker`ì˜ ê´€ê³„ëŠ” ì–‘ë°©í–¥ì´ë©°, `Member`ëŠ” ê´€ê³„ì˜ ì£¼ì¸ì´ ì•„ë‹ˆë‹¤.

ë”°ë¼ì„œ `Member`ë¥¼ í†µí•´ ì¿¼ë¦¬í•˜ë©´ `N+1 ë¬¸ì œ`ê°€ ë°œìƒí•´ì•¼ë§Œ í•œë‹¤.

<u>ì¦‰, select ì¿¼ë¦¬ê°€ ë‘ë²ˆ ë°œìƒí•  ê²ƒì´ë‹¤.</u>

<br />

```java

@DataJpaTest
@Rollback(false)
class MemberTest {

    @Autowired
    TestEntityManager em;

    @BeforeEach
    void setUp() {
        Locker locker = new Locker();
        Member member = new Member();
        member.setLocker(locker);
        em.persist(member); // insert ë‘ë²ˆ ë°œìƒ
        em.flush();
        em.clear();
    }

    @Test
    void find() throws Exception {
        // em.find(Locker.class, 1L);
        em.find(Member.class, 1L); // select ë‘ë²ˆ ë°œìƒ
    }

}
```

<br />

```shell
Hibernate: 
    insert 
    into
        member
        (name, id) 
    values
        (?, ?)
Hibernate: 
    insert 
    into
        locker
        (member_id, thing, id) 
    values
        (?, ?, ?)
Hibernate: 
    select
        member0_.id as id1_1_0_,
        member0_.name as name2_1_0_ 
    from
        member member0_ 
    where
        member0_.id=?
Hibernate: 
    select
        locker0_.id as id1_0_0_,
        locker0_.member_id as member_i3_0_0_,
        locker0_.thing as thing2_0_0_ 
    from
        locker locker0_ 
    where
        locker0_.member_id=?
```

<br />

`@OneToOne`ì— ëŒ€í•´ ì–´ëŠì •ë„ ì´í•´í•˜ê³  ìˆê³ , ì½”ë“œë¥¼ ì‘ì„±í•œ ë‹¹ì‚¬ìëŠ” ì´ëŸ¬í•œ ë¬¸ì œì—ì„œ ììœ ë¡œìš¸ìˆ˜ë„ ìˆë‹¤.

í•˜ì§€ë§Œ ì´ëŸ¬í•œ ì†ì‚¬ì •ì„ ëª¨ë¥´ëŠ” ë™ë£Œë“¤ì€ ì‹¤ìˆ˜í•  ê°€ëŠ¥ì„±ì´ ì¶©ë¶„íˆ ë†’ë‹¤.

ê·¸ë¦¬ê³  ë³µì¡í•œ ì‹¤ë¬´í™˜ê²½ì—ì„œ JPAë¥¼ ì‚¬ìš©í•˜ë‹¤ ë³´ë©´ ê²°êµ­ ì½”ë“œë§Œ ë´ì„œëŠ” ì •í™•íˆ ì–´ë–¤ ì¿¼ë¦¬ê°€ ë°œìƒí•  ê²ƒì¸ì§€ ì™„ë²½í•˜ê²Œ ì•Œê¸°ê°€ ì–´ë µë‹¤.

ê²°êµ­ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë©´ì„œ ëª¨ë‹ˆí„°ë§ì„ í•´ë´ì•¼ì§€ë§Œ ì •í™•íˆ ì–´ë– í•œ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ”ì§€ë¥¼ ì•Œ ìˆ˜ ìˆë‹¤ëŠ” ì˜ë¯¸ì´ë‹¤.

ì¦‰, ì´ëŸ¬í•œ ë¬¸ì œëŠ” ì½”ë“œë¦¬ë·°ë¥¼ í•´ë„ ì‚¬ì „ì— ì°¾ì•„ë‚´ê¸°ê°€ ì–´ë µë‹¤.

<br />

ê·¸ë ‡ë‹¤ê³  `@OneToOne`ì„ ì•„ì˜ˆ ì•ˆì“°ê¸°ëŠ” ì–´ë µë‹¤.

ì•„ë¬´ë¦¬ ì‚¬ìš©ì„ í”¼í•˜ë ¤ í•´ë„ ê°„í˜¹ê°€ë‹¤ ì‚¬ìš©í•´ì•¼í•˜ëŠ” ìˆœê°„ì´ ìˆì„ ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë©´ ì–´ë–»ê²Œ ì‚¬ìš©í•´ì•¼ ì´ë¥¼ ìŠ¬ê¸°ë¡­ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆì„ê¹Œ?

<br />

# ğŸ˜ ìŠ¬ê¸°ë¡­ê²Œ ì‚¬ìš©í•˜ê¸°

---

ìš°ì„  ìœ„ ìƒí™©ì—ì„œ í…Œì´ë¸”ì´ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì¡ŒëŠ”ì§€ DDLì„ í™•ì¸í•´ë³´ì.

<br />

```shell
Hibernate: 
    
    create table locker (
       id bigint not null,
        thing varchar(255),
        member_id bigint,
        primary key (id)
    )
Hibernate: 
    
    create table member (
       id bigint not null,
        name varchar(255),
        primary key (id)
    )
```

<br />

`locker` í…Œì´ë¸”ì—ëŠ” `pk`ì¸ `id`ì™€ `fk`ì¸ `member_id`ê°€ ìˆìŒì„ ë³¼ ìˆ˜ ìˆë‹¤.

ê·¼ë° ì—¬ê¸°ì„œ ê³¼ì—° `pk`ë¡œ ì¡í˜€ìˆëŠ” `id`ì»¬ëŸ¼ì´ í•„ìš”í• ê¹Œ?

í•„ìš”í•˜ì§€ ì•Šë‹¤ê³  ìƒê°ë˜ëŠ”ë°ë„ ë¶ˆêµ¬í•˜ê³  ì¸ë±ìŠ¤ ì»¬ëŸ¼ì„ ë‘ê°œë‚˜ ì¡ê³  ìˆë‹¤.

ì´ëŠ” íš¨ìœ¨ì ì´ì§€ ì•Šë‹¤.

ê·¸ë ‡ë‹¤ë©´ ì–´ë–»ê²Œ í•  ìˆ˜ ìˆì„ê¹Œ?

<br />

## ğŸ’¡ @MapsId

---

`javax.persistence`íŒ¨í‚¤ì§€ì—ëŠ” `@MapsId`ë¼ëŠ” ì–´ë…¸í…Œì´ì…˜ì´ ìˆë‹¤.

ì´ëŠ” `fk`ë¥¼ `pk`ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤.

ë‘ë§í•  ê²ƒ ì—†ì´ ì ìš©í•œ ì½”ë“œì™€ ê²°ê³¼ë¥¼ ë³´ì.

<br />

```java

@Table
@Setter
@Entity
public class Locker {

    // 1: @GeneratedValue ì œê±°
    @Id
    private Long id;

    @MapsId // 2: @MapsId ì¶”ê°€
    @OneToOne(fetch = FetchType.LAZY)
    private Member member;

}

@Table
@Entity
public class Member {

    @Id
    @GeneratedValue
    private Long id;

    private String title;

    // 3: ì–‘ë°©í–¥ ë§¤í•‘ -> ë‹¨ë°©í–¥ ë§¤í•‘ìœ¼ë¡œ ë³€ê²½ë¨ (=ê¸°ì¡´ ë§¤í•‘ ì œê±°ë¨)

}
```

<br />

ì¼ë‹¨ Entity í´ë˜ìŠ¤ì˜ ì½”ë“œê°€ ëŒ€í­ ì¤„ì–´ë“¤ì–´ ê°€ë…ì„±ì´ í¬ê²Œ ëŠ˜ì–´ë‚¬ë‹¤.

ì½”ë“œì—ì„œ ì£¼ëª©í•  ë¶€ë¶„ë“¤ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

<br />

- 1: @GeneratedValueê°€ ì œê±°ë˜ì—ˆë‹¤
  - `member` í…Œì´ë¸”ì˜ `pk(id)`ë¥¼ `locker` í…Œì´ë¸”ì˜ `pk`ë¡œ ì‚¬ìš©í•  ê²ƒì´ê¸° ë•Œë¬¸ì— <u>ê¸°ë³¸í‚¤ ìƒì„±ì „ëµì´ í•„ìš”í•˜ì§€ ì•Šë‹¤</u>
- 2: @MapsIdê°€ ì¶”ê°€ë˜ì—ˆë‹¤
- 3: ì–‘ë°©í–¥ ë§¤í•‘ì—ì„œ ë‹¨ë°©í–¥ ë§¤í•‘ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆë‹¤ (=ê¸°ì¡´ ë§¤í•‘ ì œê±°ë¨)

<br />

ê·¸ë¦¬ê³  ê°€ì¥ ì¤‘ìš”í•œ í…Œì´ë¸”ì— ëŒ€í•œ DDLì„ í™•ì¸í•´ë³´ì.

<br />

```shell
Hibernate: 
    
    create table locker (
       member_id bigint not null,
        primary key (member_id)
    )
Hibernate: 
    
    create table member (
       id bigint not null,
        title varchar(255),
        primary key (id)
    )
Hibernate: 
    
    alter table locker 
       add constraint FKcwdw46rsk7jstg14ey1ppkb1h 
       foreign key (member_id) 
       references member
```

<br />

ìš°ì„  `locker` í…Œì´ë¸”ì— ìˆë˜, ë¶ˆí•„ìš”í•˜ë‹¤ê³  ìƒê°ë˜ë˜ ì¸ë±ìŠ¤ ì»¬ëŸ¼ì´ ì œê±°ë˜ì—ˆë‹¤.

ê·¸ë¦¬ê³  `fk`ì˜€ë˜ `member_id`ë¥¼ `locker`í…Œì´ë¸”ì˜ `pk`ë¡œ ì‚¬ìš©í•˜ê²Œ ë˜ì—ˆìŒì„ ë³¼ ìˆ˜ ìˆë‹¤.

ì´ì œ `N+1 ë¬¸ì œ`ê°€ ë°œìƒí•˜ë˜ ì½”ë“œë¥¼ ë‹¤ì‹œ ì‹¤í–‰í•´ë³´ë©´ ì–´ë–»ê²Œ ë ê¹Œ?

<br />

```java

@DataJpaTest
@Rollback(false)
class MemberTest {

    @Autowired
    TestEntityManager em;

    @BeforeEach
    void setUp() {
        Locker locker = new Locker();
        Member member = new Member();
        locker.setMember(member);
        em.persist(locker);
        em.flush();
        em.clear();
    }

    @Test
    void find() throws Exception {
        // em.find(Locker.class, 1L);
        em.find(Member.class, 1L);
    }

}
```

<br />

```shell
Hibernate: 
    insert 
    into
        member
        (title, id) 
    values
        (?, ?)
Hibernate: 
    insert 
    into
        locker
        (member_id) 
    values
        (?)
Hibernate: 
    select
        member0_.id as id1_1_0_,
        member0_.title as title2_1_0_ 
    from
        member member0_ 
    where
        member0_.id=?
```

<br />

ì•„ì£¼ ê¹”ë”í•œ ì¿¼ë¦¬ê°€ ë°œìƒí•¨ì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

<br />

# âœ… ê²°ë¡ 

---

ì´ëŸ¬í•œ ë³€ê²½ì„ í†µí•´ ë‹¤ìŒê³¼ ê°™ì€ ì´ì ë“¤ì„ ì–»ì„ ìˆ˜ ìˆì—ˆë‹¤.

<br />

1. ë¶ˆí•„ìš”í•œ ì¸ë±ìŠ¤ ì»¬ëŸ¼ì„ ì œê±°í•´ ë°ì´í„°ë² ì´ìŠ¤ê°€ ìµœì í™”ë˜ì—ˆë‹¤
2. JPA ì½”ë“œì˜ ê°€ë…ì„±ì´ í° í­ìœ¼ë¡œ ê°œì„ ë˜ì—ˆë‹¤
3. N+1 ë¬¸ì œê°€ ë°œìƒí• ìˆ˜ë„ ìˆëŠ” ì—¬ì§€ë¥¼ ì™„ë²½í•˜ê²Œ ì°¨ë‹¨í–ˆë‹¤

<br />
